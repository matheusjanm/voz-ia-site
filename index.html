<script>
  // URL do backend (mude para o endere√ßo do seu servidor quando publicar)
  const BACKEND_URL = "http://localhost:3000/api/tts";

  const textoEl = document.getElementById("texto");
  const contador = document.getElementById("contador");
  const btnOuvir = document.getElementById("btnOuvir");
  const player = document.getElementById("player");
  const playPauseBtn = document.getElementById("playPauseBtn");
  const msgErro = document.getElementById("msgErro");
  const temaToggle = document.getElementById("temaToggle");

  let currentAudioUrl = null;
  const maxCaracteres = 10000;

  textoEl.addEventListener("input", () => {
    const qtd = textoEl.value.length;
    contador.textContent = `${qtd} / ${maxCaracteres} caracteres`;
    if (qtd > maxCaracteres) {
      msgErro.textContent = "Voc√™ ultrapassou o limite de 10.000 caracteres!";
      btnOuvir.disabled = true;
    } else {
      msgErro.textContent = "";
      btnOuvir.disabled = false;
    }
  });

  temaToggle.addEventListener("change", () => {
    if (temaToggle.checked) {
      document.body.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
    }
  });

  function limparAudio() {
    if (!player.paused) player.pause();
    player.src = "";
    if (currentAudioUrl) {
      URL.revokeObjectURL(currentAudioUrl);
      currentAudioUrl = null;
    }
    player.style.display = "none";
    playPauseBtn.style.display = "none";
  }

  btnOuvir.addEventListener("click", async () => {
    const texto = textoEl.value.trim();
    msgErro.textContent = "";
    limparAudio();

    if (!texto) {
      msgErro.textContent = "Digite um texto primeiro!";
      return;
    }

    if (texto.length > maxCaracteres) {
      msgErro.textContent = "Texto muito longo! Reduza para at√© 10.000 caracteres.";
      return;
    }

    btnOuvir.disabled = true;
    btnOuvir.textContent = "Gerando √°udio...";

    try {
      const response = await fetch(BACKEND_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ text: texto }),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Erro ${response.status}: ${errorText}`);
      }

      const blob = await response.blob();
      currentAudioUrl = URL.createObjectURL(blob);
      player.src = currentAudioUrl;
      player.style.display = "block";
      player.play();

      playPauseBtn.style.display = "inline-block";
      playPauseBtn.textContent = "‚è∏ Pausar";

    } catch (error) {
      msgErro.textContent = `Erro ao gerar √°udio: ${error.message}`;
    } finally {
      btnOuvir.disabled = false;
      btnOuvir.textContent = "üîä Ouvir Texto";
    }
  });

  playPauseBtn.addEventListener("click", () => {
    if (player.paused) {
      player.play();
      playPauseBtn.textContent = "‚è∏ Pausar";
    } else {
      player.pause();
      playPauseBtn.textContent = "‚ñ∂Ô∏è Continuar";
    }
  });

  player.addEventListener("ended", () => {
    playPauseBtn.textContent = "‚ñ∂Ô∏è Reproduzir";
  });
</script>
