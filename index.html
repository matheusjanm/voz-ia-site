<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leitor com Voz IA - Tema Claro/Escuro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* ... (seu CSS permanece igual, omitido aqui para brevidade) ... */
  </style>
</head>
<body>
  <nav class="menu">
    <h2>Menu</h2>
    <label><input type="checkbox" id="temaToggle" /> Tema Escuro</label>
    <label><input type="radio" name="menuSelect" value="leitor" checked /> Leitor de Texto</label>
    <label><input type="radio" name="menuSelect" value="conversor" /> Converter MP4 ‚Üí MP3</label>
    <label><input type="radio" name="menuSelect" value="transcrever" /> Transcrever √Åudio/V√≠deo</label>
  </nav>

  <main class="container">
    <section id="leitorSection" class="main-area">
      <h1>Leitor com Voz IA</h1>
      <textarea id="texto" placeholder="Cole seu texto aqui..."></textarea>
      <button id="btnOuvir">üîä Ouvir Texto</button>
      <button id="playPauseBtn">‚è∏ Pausar</button>
      <audio id="player" controls style="display:none;"></audio>
      <div id="msgErro"></div>
    </section>

    <section id="conversorSection" class="main-area" style="display:none;">
      <h2>Converter v√≠deo para MP3</h2>
      <form id="uploadForm">
        <input type="file" id="videoInput" accept="video/*" required />
        <button type="submit">Converter e Baixar MP3</button>
        <div id="uploadMsg" style="margin-top:10px; font-weight:600; color:#3b82f6;"></div>
      </form>
    </section>

    <section id="transcreverSection" class="main-area" style="display:none;">
      <h2>Transcrever √Åudio ou V√≠deo para Texto</h2>
      <form id="transcribeForm">
        <input type="file" id="audioVideoInput" accept="audio/*,video/*" required />
        <button type="submit">Transcrever</button>
      </form>
      <div id="transcribeMsg" style="margin-top:10px; font-weight:600;"></div>
      <textarea id="transcribedText" placeholder="Transcri√ß√£o aparecer√° aqui..." style="margin-top:15px;"></textarea>
    </section>
  </main>

  <script>
    // Tema escuro
    document.getElementById("temaToggle").addEventListener("change", e => {
      document.body.classList.toggle("dark", e.target.checked);
    });

    // Alternar menus
    const sections = {
      leitor: document.getElementById("leitorSection"),
      conversor: document.getElementById("conversorSection"),
      transcrever: document.getElementById("transcreverSection")
    };
    document.querySelectorAll('input[name="menuSelect"]').forEach(r => {
      r.addEventListener("change", () => {
        Object.entries(sections).forEach(([key, el]) => {
          el.style.display = (r.value === key) ? "flex" : "none";
        });
      });
    });

    // Leitor
    const textoEl = document.getElementById("texto");
    const btnOuvir = document.getElementById("btnOuvir");
    const player = document.getElementById("player");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const msgErro = document.getElementById("msgErro");
    let currentAudioUrl = null;

    btnOuvir.addEventListener("click", async () => {
      const texto = textoEl.value.trim();
      if (!texto) return alert("Digite um texto primeiro!");
      btnOuvir.disabled = true;
      limparAudio();
      msgErro.textContent = "";
      try {
        const res = await fetch("http://localhost:3000/api/tts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: texto })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        currentAudioUrl = URL.createObjectURL(blob);
        player.src = currentAudioUrl;
        player.style.display = "block";
        player.play();
        playPauseBtn.style.display = "inline-block";
        playPauseBtn.textContent = "‚è∏ Pausar";
      } catch (e) {
        msgErro.textContent = "Erro ao gerar voz: " + e.message;
      } finally {
        btnOuvir.disabled = false;
        btnOuvir.textContent = "üîä Ouvir Texto";
      }
    });

    playPauseBtn.addEventListener("click", () => {
      if (player.paused) {
        player.play();
        playPauseBtn.textContent = "‚è∏ Pausar";
      } else {
        player.pause();
        playPauseBtn.textContent = "‚ñ∂Ô∏è Continuar";
      }
    });

    function limparAudio() {
      if (!player.paused) player.pause();
      player.src = "";
      if (currentAudioUrl) URL.revokeObjectURL(currentAudioUrl);
      currentAudioUrl = null;
      player.style.display = "none";
      playPauseBtn.style.display = "none";
    }

    // Conversor MP4 ‚Üí MP3
    const uploadForm = document.getElementById("uploadForm");
    const uploadMsg = document.getElementById("uploadMsg");
    uploadForm.addEventListener("submit", async e => {
      e.preventDefault();
      const file = document.getElementById("videoInput").files[0];
      if (!file) return uploadMsg.textContent = "Selecione um arquivo de v√≠deo.";
      const formData = new FormData();
      formData.append("video", file);
      uploadMsg.textContent = "Convertendo...";
      try {
        const res = await fetch("http://localhost:3000/api/convert", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = file.name.replace(/\.[^/.]+$/, "") + ".mp3";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        uploadMsg.textContent = "Download iniciado!";
      } catch (err) {
        uploadMsg.textContent = "Erro: " + err.message;
      }
    });

    // Transcrever √°udio ou v√≠deo
    const transcribeForm = document.getElementById("transcribeForm");
    const transcribeMsg = document.getElementById("transcribeMsg");
    const transcribedText = document.getElementById("transcribedText");

    transcribeForm.addEventListener("submit", async e => {
      e.preventDefault();
      const file = document.getElementById("audioVideoInput").files[0];
      if (!file) return transcribeMsg.textContent = "Selecione um arquivo.";
      const formData = new FormData();
      formData.append("media", file);
      transcribeMsg.textContent = "Transcrevendo...";
      try {
        const res = await fetch("http://localhost:3000/api/transcribe", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error(await res.text());
        const { text } = await res.json();
        transcribedText.value = text;
        transcribeMsg.textContent = "Transcri√ß√£o conclu√≠da.";
      } catch (err) {
        transcribeMsg.textContent = "Erro: " + err.message;
      }
    });
  </script>
</body>
</html>
